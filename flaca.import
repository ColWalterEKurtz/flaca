#!/bin/bash

# ------------------------------------------------------------------------------
# settings                                                              settings
# ------------------------------------------------------------------------------
set -o errtrace  # any trap on ERR is inherited by shell functions,
                 #   command substitutions, and commands executed in a subshell
                 #   environment
set -o nounset   # treat unset variables and parameters other than the special
                 #   parameters "@" and "*" as an error when performing
                 #   parameter expansion
set -o pipefail  # the return value of a pipeline is the value of the last
                 #   (rightmost) command to exit with a non-zero status, or
                 #   zero if all commands in the pipeline exit successfully

# set language
export LANG="en_US.UTF-8"

# use dot as decimal separator
export LC_NUMERIC="en_US.UTF-8"

# ------------------------------------------------------------------------------
# commands                                                              commands
# ------------------------------------------------------------------------------

# set default values
OPMODE="RESET"
REMOTE=""

# check number of passed parameters
if (( $# == 2 )) ; then

  if [ "$1" == "-k" ] ; then

    # keep timestamps
    OPMODE="KEEP"

    # set remote directory
    REMOTE="$2"

  else

    # notify user
    flaca.common failmsg "unknown option: \"$1\""

    # signalize trouble
    exit 1

  fi

# check number of passed parameters
elif (( $# == 1 )) ; then

  # set remote directory
  REMOTE="$1"

# invalid command line
else

  # show syntax
  echo
  echo "$(basename "$0") [-k] <source dir>"
  echo

  # signalize trouble
  exit 1

fi

# check remote directory
if [ -z "$REMOTE" ] || [ ! -d "$REMOTE" ] ; then

  # notify user
  flaca.common failmsg "unable to locate source directory: \"$REMOTE\""

  # signalize trouble
  exit 1

fi

# create temporary files
TMPLOCAL=$(mktemp --suffix=".local")
TMPREMOTE=$(mktemp --suffix=".remote")

# clean up on exit
trap 'rm -f "$TMPLOCAL" "$TMPREMOTE"' EXIT

# show progress
flaca.common infomsg "searching local pdf files"

# find local pdf files
find -type      "f"                 \
     -regextype "posix-extended"    \
     -regex     ".+\.[Pp][Dd][Ff]$" \
| sort                              \
| while read -r FLASHCARD
do

  sha1sum "$FLASHCARD"

done | sort > "$TMPLOCAL"

# show progress
flaca.common infomsg "searching remote pdf files"

# find remote pdf files
find "$REMOTE"                      \
     -type      "f"                 \
     -regextype "posix-extended"    \
     -regex     ".+\.[Pp][Dd][Ff]$" \
| sort                              \
| while read -r FLASHCARD
do

  sha1sum "$FLASHCARD"

done | sort > "$TMPREMOTE"

# show progress
flaca.common infomsg "searching missing pdf files"

# find hash values that are unique to file 2 (remote pdf files)
comm -13 <(sed -re "s/ .+//" "$TMPLOCAL")  \
         <(sed -re "s/ .+//" "$TMPREMOTE") \
| while read -r HASHKEY
do

  # get related source file
  SRCFILE=$(sed -nre "s/^$HASHKEY[[:space:]]+([^[:space:]].+)/\1/p" "$TMPREMOTE")

  # check operation mode
  if [ "$OPMODE" == "RESET" ] ; then

    # reset timestamps
    TARGETPATH=$(basename "$SRCFILE" | sed -re "s/^[[:digit:]]{12}-[[:digit:]]{12}-(.+)/\1/ ; s/.+/000000000000-000000000000-&/")

  else

    # keep timestamps
    TARGETPATH=$(basename "$SRCFILE" | sed -re "/^[[:digit:]]{12}-[[:digit:]]{12}-.+/{ b } ; s/.+/000000000000-000000000000-&/")

  fi

  # check if file already exists
  if [ -f "$TARGETPATH" ] ; then

    # notify user
    flaca.common warnmsg "skipping file with existing path: \"$TARGETPATH\""

    # try next file
    continue

  fi

  # copy source file to first box
  cp "$SRCFILE" "$TARGETPATH" &>"/dev/null"

  # check operation
  if [ -f "$TARGETPATH" ] ; then

    # show progress
    flaca.common donemsg "file imported: $SRCFILE"

  else

    # notify user
    flaca.common failmsg "unable to copy file: \"$SRCFILE\""

    # signalize trouble
    exit 1

  fi

done

# signalize success
exit 0

